# ğŸ“˜ T2G Pipeline â€” ConfiguraciÃ³n Ã“ptima
# ======================================
# Este pipeline ejecuta el flujo completo del proyecto T2G:
# PDF/DOCX/IMG â†’ IR homogÃ©neo â†’ Contexto Global (doc) â†’ Chunks con Hints â†’ 
# Contexto Local (modo light) â†’ SelecciÃ³n Adaptativa de Esquemas

pipeline:
  dry_run: false                # Ejecuta realmente las etapas
  continue_on_error: true       # ContinÃºa aunque falle una etapa puntual

stages:

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1 PARSER â€” ConversiÃ³n de documentos a IR homogÃ©neo JSON
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: parse
    args:
      clean_outdir: true
      inputs_glob:
        - "docs/*.pdf"
        - "docs/*.docx"
        - "docs/*.png"
        - "docs/*.jpg"
        - "docs/*.csv"
      outdir: "outputs_ir"
      # ğŸ’¡ Convierte documentos heterogÃ©neos a estructura DocumentIR
      # Incluye detecciÃ³n de tablas, layout y metadatos bÃ¡sicos

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2 CONTEXTIZER (DOC-LEVEL) â€” Contexto global hÃ­brido adaptativo
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: contextize-doc
    args:
      clean_outdir: true
      ir_glob: "outputs_ir/*.json"
      embedding_model: "all-MiniLM-L6-v2"
      nr_topics: null
      seed: 42
      outdir: "outputs_doc_topics"

      # âš™ï¸ ParÃ¡metros avanzados del Contextizer hÃ­brido
      use_hybrid: false           # Activa el modo hÃ­brido adaptativo (TF-IDF + KeyBERT + embeddings)
      use_keybert: true          # Extrae keywords semÃ¡nticas con SentenceTransformers
      enable_mmr: false           # Activa Maximal Marginal Relevance (reduce redundancia)
      hybrid_eps: 0.25           # Radio de vecindad (DBSCAN adaptativo)
      hybrid_min_samples: 2      # Muestras mÃ­nimas por cluster (DBSCAN)
      cache_dir: "cache/"        # Carpeta opcional para embeddings cacheados

      # ğŸ’¡ Salida: DocumentIR enriquecido con meta.topics_doc
      # Este contexto global serÃ¡ heredado por el Chunker.

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 3 CHUNKER â€” SegmentaciÃ³n semÃ¡ntica adaptativa
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: chunk
    args:
      clean_outdir: true
      ir_glob: "outputs_doc_topics/*.json"
      outdir: "outputs_chunks"
      max_tokens: 2048
      min_chars: 280
      use_embeddings: true
      embedding_model: "all-MiniLM-L6-v2"
      spacy_model: "es_core_news_sm"
      seed: 42
      # ğŸ’¡ Divide en chunks semÃ¡nticos preservando cohesiÃ³n y contexto global
      # Hereda topic_hints desde meta.topics_doc

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 4 CONTEXTIZER (CHUNK-LEVEL) â€” Modo LIGHT por defecto
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: contextize-chunks
    args:
      chunks_glob: "outputs_chunks/*.json"
      embedding_model: "all-MiniLM-L6-v2"
      nr_topics: null
      seed: 42
      outdir: "outputs_chunks"    # Sobrescribe enriqueciendo los mismos archivos

      # âš¡ Modo LIGHT (automÃ¡tico)
      # - No aplica clustering
      # - Usa topic_hints heredados del Chunker
      # - Refina keywords locales con KeyBERT + TF-IDF + MMR

      use_keybert: true           # Mantiene extracciÃ³n semÃ¡ntica local
      enable_mmr: true            # DiversificaciÃ³n local (sin redundancia)
      fusion_weights: [0.5, 0.3, 0.2]  # Peso relativo: TF-IDF / KeyBERT / embeddings

      # ğŸ’¡ Salida: DocumentChunks con meta.topics_chunks

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 5 SCHEMA SELECTOR â€” SelecciÃ³n adaptativa de dominios/esquemas
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: schema-select
    args:
      clean_outdir: true
      chunks_glob: "outputs_chunks/*.json"
      outdir: "outputs_schema"

      # --- Pesos de seÃ±ales ---
      alpha_kw: 0.20       # Keywords (lÃ©xica)
      beta_emb: 0.40       # Embeddings (semÃ¡ntica densa)
      gamma_ctx: 0.20      # MÃ©tricas contextuales (cohesiÃ³n, health, novelty)
      delta_top: 0.15      # Afinidad de tÃ³picos globales/locales
      epsilon_prior: 0.05  # Priors (sesgos organizacionales)

      # --- Umbrales y control ---
      ambig_threshold: 0.12       # Diferencia mÃ­nima para marcar ambigÃ¼edad
      fallback_threshold: 0.10   # Confianza mÃ­nima antes de fallback genÃ©rico
      softmax_temp: 0.85           # Temperatura del softmax (controla confianza)
      disable_generic: false       # Si true, desactiva fallback genÃ©rico

      # --- SelecciÃ³n de dominios ---
      topk_domains: 3              # CuÃ¡ntos dominios devuelve a nivel doc
      max_domains: 3               # MÃ¡ximo de dominios evaluados

      # ğŸ’¡ Salida: JSON con distribuciÃ³n de scores por dominio
      # Este resultado alimentarÃ¡ futuras etapas (Mentions / Graph)
